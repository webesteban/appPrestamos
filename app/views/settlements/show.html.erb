<div class="container-fluid">
  <div class="row">
    <!-- Panel izquierdo -->
    <div class="col-md-3">

      <div class="card p-2">
        <h6>Reportes</h6>
        <div class="d-grid gap-2">
          <%= link_to "Ver compras", loans_reports_path(level: "collection", hierarchy_id: @settlement.collection_id, date: @settlement.settlement_date ), class: "btn btn-dark", data: { turbo: false } %>
          <%= link_to "Ver abonos",  loans_reports_path(level: "payments", hierarchy_id: @settlement.collection_id, date: @settlement.settlement_date), class: "btn btn-primary", data: { turbo: false } %>
          <%= link_to "Liquidaciones", settlements_reports_path(collection_id: @settlement.collection_id), class: "btn btn-info", data: { turbo: false } %>
          <button class="btn btn-dark" disabled>Ultimas compras</button>
          <button class="btn btn-warning" disabled>Faltantes</button>
          <button class="btn btn-success" disabled>Morocidad de ruta</button>
          <button class="btn btn-danger" disabled>Graficas ruta</button>
        </div>
      </div>
      <div class="card">
      <div class="card-body">
        <h5 class="text-muted fs-13 text-uppercase" title="Number of Orders">Cartera</h5>
        <p class="mb-1">
          <span class="text-primary me-1"><i class="ti ti-point-filled"></i></span>
          <span class="text-nowrap text-muted">Cartera total (<%= Loan.joins(:client).where(clients: { collection_id: @settlement.collection_id }).where(status: [:active, :overdue]).count %>)</span>
          <span class="float-end"><b><%= Loan.joins(:client).where(clients: { collection_id: @settlement.collection_id }).where(status: [:active, :overdue]).sum(:amount) %></b></span>
        </p>
        <p class="mb-0">
          <span class="text-primary me-1"><i class="ti ti-point-filled"></i></span>
          <span class="text-nowrap text-muted">Cartera vencida (<%= Loan.joins(:client).where(clients: { collection_id: @settlement.collection_id }).where(status: [:active, :overdue]).where("end_date < ?", Time.zone.today).count %>)</span>
          <span class="float-end"><b><%= Loan.joins(:client).where(clients: { collection_id: @settlement.collection_id }).where(status: [:active, :overdue]).where("end_date < ?", Time.zone.today).sum(:amount) %></b></span>
        </p>
      </div>
    </div>
    </div>

    <!-- Panel central -->
    <div class="col-md-6">
      <div class="card p-3">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="mb-0">Ruta: <%= @settlement.collection.name %> â€” <%= @settlement.settlement_date %></h5>
          <span class="badge <%= @settlement.closed? ? 'bg-primary' : 'bg-secondary' %>">
            <%= @settlement.status.upcase %>
          </span>
        </div>

        <%= form_with model: @settlement,
                      url: settlement_path(@settlement),
                      method: :put,
                      local: true do |f| %>
          <div class="row g-2 mt-2">
            <div class="col-6">
              <label>BASE</label>
              <%= f.number_field :base_start, step: "0.01", class: "form-control", disabled: true %>
            </div>
            <div class="col-6">
              <label>GASTOS (del sistema)</label>
              <input class="form-control" value="<%= number_to_currency(@settlement.expenses_total) %>" disabled>
            </div>
            <div class="col-6">
              <label>ABONOS</label>
              <input class="form-control" value="<%= number_to_currency(@settlement.payments_total) %>" disabled>
            </div>
            <div class="col-6">
              <label>COMPRAS</label>
              <input class="form-control" value="<%= number_to_currency(@settlement.loans_total) %>" disabled>
            </div>
          </div>
        <% end %>

        <!-- Totales calculados (se refrescan con Turbo) -->
        <div class="mt-3 d-block">
          <turbo-frame id="settlement_totals">
            <%= render "settlements/totals", settlement: @settlement %>
          </turbo-frame>
        </div>

        <!-- Gastos -->
        <div class="mt-3 d-block">
          <turbo-frame id="expenses_frame" class="">
            <%= render "expenses/list", settlement: @settlement %>
            <%= render "expenses/form", settlement: @settlement %>
          </turbo-frame>
        </div>

        <div class="mt-3 d-flex gap-2">
          <%= button_to "ðŸ”„ Recalcular", recalculate_settlement_path(@settlement), method: :post, class: "btn btn-outline-info" %>
          <%= button_to "Cerrar liquidaciÃ³n", close_settlement_path(@settlement), method: :post, class: "btn btn-primary" %>
        </div>
      </div>
    </div>

    <!-- Panel derecho -->
    <div class="col-md-3">
      <div class="card p-2 mb-3">
        <h6>Movimientos del dÃ­a</h6>

        <!-- Retanqueos -->
        <turbo-frame id="topups_frame">
          <%= render "settlement_topups/list", settlement: @settlement %>
        </turbo-frame>

        <!-- Retiros -->
        <turbo-frame id="withdrawals_frame" class="mt-3 d-block">
          <%= render "settlement_withdrawals/list", settlement: @settlement %>
        </turbo-frame>
      </div>
    </div>
  </div>
</div>
